<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Editor Pro - Integraci√≥n Fluida</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.26/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.26/"></script>
  <style>
    body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; font-family: sans-serif; background-color: transparent; }
    #viewDiv { width: 100%; height: 100vh; }
    .action-bar { position: absolute; top: 10px; right: 10px; display: flex; flex-direction: column; gap: 6px; z-index: 100; }
    .action-bar button { padding: 8px 12px; background: white; border: 1px solid #0079c1; border-radius: 4px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-size: 11px; }
    #attributesPanel { position: absolute; top: 0; left: -350px; width: 300px; height: 100%; background: white; z-index: 101; transition: left 0.3s ease; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.2); overflow-y: auto; }
    #attributesPanel.open { left: 0; }
    .lote-item { border: 1px solid #ddd; padding: 10px; margin-bottom: 8px; border-radius: 4px; font-size: 12px; }
    .btn-select-attr { width: 100%; margin-top: 5px; padding: 5px; background: #0079c1; color: white; border: none; cursor: pointer; }
    .btn-save { width: 100%; margin-top: 15px; padding: 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
    #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 10px 20px; border-radius: 4px; color: white; opacity: 0; transition: opacity 0.4s; z-index: 1000; font-size: 13px; pointer-events: none; }
    #toast.show { opacity: 1; }
  </style>
</head>
<body>
  <div id="viewDiv"></div>
  <div id="attributesPanel"><span style="float:right; cursor:pointer; color:red; font-weight:bold;" onclick="closePanel()">‚úï</span><h3 id="panelTitle">Atributos</h3><div id="selectorContainer" style="display:none;"><p>Heredar datos de:</p><div id="lotesList"></div></div><div id="formSection"><div id="formContainer"></div><button class="btn-save" id="saveAttrsBtn">üíæ Guardar Cambios</button></div></div>
  <div class="action-bar"><button id="drawBtn">‚ûï Dibujar</button><button id="unirBtn">üîó Combinar</button><button id="explotarBtn">üí• Explotar</button><button id="cortarBtn">‚úÇÔ∏è Cortar</button><button id="infoBtn">üìã Datos</button></div>
  <div id="toast"></div>

  <script>
    require([
      "esri/identity/IdentityManager", "esri/identity/OAuthInfo", "esri/Map", "esri/views/MapView", "esri/layers/FeatureLayer",
      "esri/layers/GraphicsLayer", "esri/widgets/FeatureForm", "esri/geometry/geometryEngine", "esri/Graphic", "esri/widgets/Sketch/SketchViewModel"
    ], function(IdentityManager, OAuthInfo, Map, MapView, FeatureLayer, GraphicsLayer, FeatureForm, geometryEngine, Graphic, SketchViewModel) {

      // 1. CONFIGURACI√ìN DE OAUTH CON POPUP PARA EVITAR BLOQUEOS DE IFRAME
      const info = new OAuthInfo({
        appId: "YGJPRC9c0NNe4Qou",
        popup: true, 
        portalUrl: "https://www.arcgis.com",
        preserveUrlHash: true
      });
      IdentityManager.registerOAuthInfos([info]);

      // Intento silencioso para no pedir login si ya existe la sesi√≥n
      IdentityManager.checkSignInStatus(info.portalUrl + "/sharing").catch(() => {
          console.log("Sesi√≥n no detectada, el usuario deber√° permitir el acceso en el popup.");
      });

      const featureLayer = new FeatureLayer({
        url: "https://services.arcgis.com/K1N9k0GQ4uh0JzlT/arcgis/rest/services/Capa_test_edicion/FeatureServer/0",
        outFields: ["*"],
        editable: true
      });

      const map = new Map({ basemap: "streets-navigation-vector", layers: [featureLayer] });
      const view = new MapView({ container: "viewDiv", map: map, center: [-63.67, -31.91], zoom: 12 });
      const graphicsLayer = new GraphicsLayer();
      map.add(graphicsLayer);

      // SNAPPING PARA EDICI√ìN PRECISA
      const sketchVM = new SketchViewModel({ 
        view, layer: graphicsLayer,
        snappingOptions: { enabled: true, featureSources: [{ layer: featureLayer, enabled: true }] }
      });

      // L√ìGICA DE ZOOM DIN√ÅMICO DESDE DASHBOARD
      const urlParams = new URLSearchParams(window.location.search);
      const targetId = urlParams.get("id");
      if (targetId) {
        view.when(() => {
          featureLayer.queryFeatures({ where: `Id_ciampagna = '${targetId}'`, returnGeometry: true }).then(res => {
            if (res.features.length > 0) view.goTo(res.features[0].geometry.extent.expand(2));
          });
        });
      }

      function showToast(msg, color = "#28a745") { const t = document.getElementById("toast"); t.innerText = msg; t.style.backgroundColor = color; t.className = "show"; setTimeout(() => t.className = "", 3000); }
      window.closePanel = () => { document.getElementById("attributesPanel").classList.remove("open"); document.getElementById("selectorContainer").style.display = "none"; document.getElementById("formSection").style.display = "block"; };

      function handleServerResponse(res, successMsg) {
        const error = res.addFeatureResults?.find(r => r.error) || res.deleteFeatureResults?.find(r => r.error) || res.updateFeatureResults?.find(r => r.error);
        if (error) alert("Error:\n" + error.error.message);
        else { showToast(successMsg); featureLayer.refresh(); graphicsLayer.removeAll(); selectedGraphics = []; closePanel(); }
      }

      view.on("click", (event) => {
        view.hitTest(event).then((res) => {
          const hit = res.results.find(r => r.graphic.layer === featureLayer);
          if (!event.native.shiftKey) { graphicsLayer.removeAll(); selectedGraphics = []; }
          if (hit) {
            selectedGraphics.push(hit.graphic);
            const highlight = hit.graphic.clone();
            highlight.symbol = { type: "simple-fill", color: [255, 255, 0, 0.4], outline: { color: "red", width: 2 }};
            graphicsLayer.add(highlight);
            featureForm.feature = hit.graphic;
          }
        });
      });

      let selectedGraphics = [];
      const featureForm = new FeatureForm({ container: "formContainer", layer: featureLayer });

      document.getElementById("drawBtn").onclick = () => sketchVM.create("polygon");
      
      document.getElementById("unirBtn").onclick = () => {
        if (selectedGraphics.length < 2) return showToast("Shift+Clic en 2+ lotes", "#dc3545");
        const list = document.getElementById("lotesList"); list.innerHTML = "";
        document.getElementById("formSection").style.display = "none";
        document.getElementById("selectorContainer").style.display = "block";
        document.getElementById("attributesPanel").classList.add("open");
        selectedGraphics.forEach((g, i) => {
          const div = document.createElement("div"); div.className = "lote-item";
          div.innerHTML = `<strong>ID:</strong> ${g.attributes.Id_ciampagna || 'N/A'}<br><button class="btn-select-attr" data-idx="${i}">Usar este ID</button>`;
          list.appendChild(div);
        });
        list.onclick = (e) => {
          if (e.target.dataset.idx) {
            const attrs = { ...selectedGraphics[e.target.dataset.idx].attributes };
            const union = geometryEngine.simplify(geometryEngine.union(selectedGraphics.map(g => g.geometry)));
            delete attrs.OBJECTID;
            attrs.Id_ciampagna = (attrs.Id_ciampagna || "U") + "_UNI" + Math.floor(Math.random()*100);
            featureLayer.applyEdits({ deleteFeatures: selectedGraphics, addFeatures: [new Graphic({ geometry: union, attributes: attrs })] }).then(res => handleServerResponse(res, "üîó Uni√≥n exitosa"));
          }
        };
      };

      document.getElementById("explotarBtn").onclick = () => {
        if (selectedGraphics.length !== 1) return;
        const g = selectedGraphics[0]; if (g.geometry.rings.length <= 1) return;
        const adds = g.geometry.rings.map((ring, i) => {
          const geom = g.geometry.clone(); geom.rings = [ring];
          const attrs = { ...g.attributes }; delete attrs.OBJECTID;
          attrs.Id_ciampagna = `EXP_${Math.floor(Math.random()*1000)}_${i}`;
          return new Graphic({ geometry: geom, attributes: attrs });
        });
        featureLayer.applyEdits({ deleteFeatures: [g], addFeatures: adds }).then(res => handleServerResponse(res, "üí• Pol√≠gono explotado"));
      };

      document.getElementById("cortarBtn").onclick = () => { if (selectedGraphics.length > 0) sketchVM.create("polyline"); };

      sketchVM.on("create", (event) => {
        if (event.state === "complete") {
          if (event.graphic.geometry.type === "polygon") {
            const feat = new Graphic({ geometry: event.graphic.geometry, attributes: { Id_ciampagna: "NUEVO_"+Date.now(), Superficie: 0 } });
            featureLayer.applyEdits({ addFeatures: [feat] }).then(res => handleServerResponse(res, "‚úÖ Guardado"));
          } else if (event.graphic.geometry.type === "polyline") {
            const cut = geometryEngine.cut(geometryEngine.simplify(selectedGraphics[0].geometry), event.graphic.geometry);
            if (cut.length > 1) {
              const adds = cut.map((geom, i) => {
                const attrs = { ...selectedGraphics[0].attributes }; delete attrs.OBJECTID;
                attrs.Id_ciampagna = `CORTE_${Math.floor(Math.random()*1000)}_${i}`;
                return new Graphic({ geometry: geom, attributes: attrs });
              });
              featureLayer.applyEdits({ deleteFeatures: [selectedGraphics[0]], addFeatures: adds }).then(res => handleServerResponse(res, "‚úÇÔ∏è Cortado"));
            }
          }
        }
      });

      document.getElementById("saveAttrsBtn").onclick = () => {
        const update = featureForm.feature.clone();
        update.attributes = { ...update.attributes, ...featureForm.getValues() };
        featureLayer.applyEdits({ updateFeatures: [update] }).then(res => handleServerResponse(res, "üíæ Guardado"));
      };

      document.getElementById("infoBtn").onclick = () => { if (selectedGraphics.length > 0) document.getElementById("attributesPanel").classList.add("open"); };
    });
  </script>
</body>
</html>
