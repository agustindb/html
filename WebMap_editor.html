<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Editor con WebMap + OAuth</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://js.arcgis.com/4.26/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.26/"></script>
</head>
<body>
  <div id="viewDiv" style="width: 100vw; height: 100vh;"></div>

  <script>
    require([
      "esri/identity/OAuthInfo",
      "esri/identity/IdentityManager",
      "esri/WebMap",
      "esri/views/MapView"
    ], function(OAuthInfo, esriId, WebMap, MapView) {

      const CLIENT_ID = "6IysV3XMGJIa37Wa";
      const PORTAL_URL = "https://mapasydatos.maps.arcgis.com";

      const info = new OAuthInfo({
        appId: CLIENT_ID,
        portalUrl: PORTAL_URL,
        popup: true
      });

      esriId.registerOAuthInfos([info]);

      console.log("üîê Iniciando autenticaci√≥n...");

      esriId.checkSignInStatus(PORTAL_URL + "/sharing")
        .then(() => {
          console.log("‚úÖ Ya autenticado");
          iniciarWebMap();
        })
        .catch(() => {
          console.log("üîÑ Requiere autenticaci√≥n, abriendo popup...");
          esriId.getCredential(PORTAL_URL + "/sharing").then(() => {
            console.log("‚úÖ Autenticado desde popup");
            iniciarWebMap();
          }).catch((err) => {
            console.error("‚ùå Error autenticaci√≥n:", err);
          });
        });

      function iniciarWebMap() {
        console.log("üó∫Ô∏è Cargando WebMap...");

        const webmap = new WebMap({
          portalItem: {
            id: "8849d965dc3645fb88fb47daca23bed9"
          }
        });

        webmap.load()
          .then(() => {
            console.log("‚úÖ WebMap cargado correctamente");

            const view = new MapView({
              container: "viewDiv",
              map: webmap
            });

            view.when(() => {
              console.log("üìå MapView inicializado. Centro:", view.center.toJSON());
            });

          })
          .catch((err) => {
            console.error("‚ùå No se pudo cargar el WebMap:", err);
          });
      }
    });
  </script>
</body>
</html>
