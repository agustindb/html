<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Editor con Corte y Dibujo</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.26/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.26/"></script>
</head>
<body>
  <div id="viewDiv" style="width:100%; height:100vh;"></div>
  <script>
    require([
      "esri/identity/OAuthInfo",
      "esri/identity/IdentityManager",
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer"
    ], function(OAuthInfo, esriId, Map, MapView, FeatureLayer) {

      const info = new OAuthInfo({
        appId: "6IysV3XMGJIa37Wa",
        popup: true,
        flowType: "auto",
        portalUrl: "https://mapasydatos.maps.arcgis.com"
      });
      esriId.registerOAuthInfos([info]);

      console.log("üåê Registrando OAuth con App ID:", info.appId);

      esriId.checkSignInStatus(info.portalUrl + "/sharing")
        .then(() => {
          console.log("‚úÖ Usuario ya autenticado");
          initLayer();
        })
        .catch(() => {
          console.log("‚ö†Ô∏è Usuario no autenticado, solicitando login");
          return esriId.getCredential(info.portalUrl + "/sharing");
        })
        .then(() => {
          console.log("‚úÖ Credencial obtenida correctamente despu√©s del login");
          initLayer();
        })
        .catch((error) => {
          if (error.name === "identity-manager:user-aborted") {
            console.warn("‚ö†Ô∏è Login abortado manualmente (usuario cerr√≥ popup o cancel√≥)");
          } else {
            console.error("‚ùå Error en el flujo OAuth:", error);
          }
        });

      window.addEventListener("message", function(event) {
        if (event.data === "oauth-callback") {
          console.log("‚úÖ Callback OAuth recibido correctamente");
        }
      });

      function initLayer() {
        const featureLayer = new FeatureLayer({
          url: "https://services.arcgis.com/K1N9k0GQ4uh0JzlT/arcgis/rest/services/Capa_test_edicion/FeatureServer/0",
          outFields: ["*"],
          editable: true,
          definitionExpression: "1=1"
        });

        featureLayer.load().then(() => {
          console.log("‚úÖ FeatureLayer cargado con token correctamente");

          const map = new Map({
            basemap: "streets-navigation-vector",
            layers: [featureLayer]
          });

          const view = new MapView({
            container: "viewDiv",
            map: map,
            center: [-58, -34],
            zoom: 6
          });

          console.log("‚úÖ Mapa y capa visibles");
        }).catch((error) => {
          console.error("‚ùå Error cargando FeatureLayer:", error);
        });
      }

    });
  </script>
</body>
</html>
